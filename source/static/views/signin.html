<view-properties>
    {
        "title": "view.signin.title",
        "fillwindow": true
    }
</view-properties>

<view-head>
    <style>
        .container {
            width: 80vw;
            height: 75vh;
            max-width: 200px;

            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            margin: auto;
            z-index: 1000;

            display: flex;
            flex-direction: column;
            justify-content: space-around;
        }

        .container form {
            width: 100%;
            height: 100%;
        }

        .container form .block-top {
            width: 100%;
        }

        .container form .block-top .image-container {
            width: 100%;
            height: 100px;
            position: relative;
        }

        .container form .block-top .image-container img {
            width: 80px;
            height: 80px;
            
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            margin: auto;
        }

        .container form .existing-profile .image-container img {
            border-radius: 50%;
        }

        form input {
            color: black;
        }
    </style>
</view-head>

<view-body>
    <script>
        (async function() {
            var continueView = null;
            var referrerView = null;
            var targetProfile = localStorage.getItem('signin-target-profile');
            if (targetProfile) {
                referrerView = 'profile-selection';
                localStorage.removeItem('signin-target-profile');
                targetProfile = await profile.find(targetProfile);

                document.querySelector('form[form-signin] .new-profile').style.display = 'none';
                document.querySelector('form[form-signin] .existing-profile').style.display = null;

                document.querySelector('form[form-signin] .existing-profile h1').innerText = targetProfile.displayname;
                document.querySelector('form[form-signin] .existing-profile img').src = targetProfile.localAvatar;
            }

            if (localStorage.getItem('signin-referrer')) {
                referrerView = localStorage.getItem('signin-referrer');
                localStorage.removeItem('signin-referrer')
            }

            if (localStorage.getItem('signin-continue')) {
                continueView = localStorage.getItem('signin-continue');
                localStorage.removeItem('signin-continue')
            }

            if (referrerView) {
                document.querySelector('form[form-signin] .button-back').style.display = null;
                document.querySelector('form[form-signin] .button-back').setAttribute('load-view', referrerView);
            }

            document.querySelector('form[form-signin]').addEventListener('submit', e => {
                e.preventDefault();

                async function cb(res) {
                    if (!res.success) {
                        alert(res.error);
                    } else {
                        if (await profile.load(res.profile.username)) {
                            view.load(continueView || 'my-profile');
                        } else {
                            alert('An unexpected error occured: Your profile is not signed in, please try restarting or reinstalling the application.');
                        }
                    }
                }

                if (targetProfile) {
                    profile.authenticate(targetProfile.username, e.target.password.value).then(res => cb(res));
                } else {
                    profile.byIdentifier(e.target.identifier.value, e.target.password.value).then(res => cb(res));
                }
            });
        })();
    </script>
</view-body>

<view-content>
    <div class="container">
        <form form-signin>
            <div class="block-top existing-profile" style="display:none;">
                <div class="image-container">
                    <img src="img/profile/default.png" alt="">
                </div>
                <h1>Username</h1>
            </div>
            
            <div class="block-top new-profile">
                <div class="image-container">
                    <img src="img/leafal/logo.png" alt="">
                </div>
                <input type="text" name="identifier" data-lang="placeholder:view.signin.identifier">
            </div>

            <input type="password" name="password" data-lang="placeholder:view.signin.password">
            <div class="buttons">
                <button type="button" data-lang="view.signin.back" class="button-back" style="display:none;"></button>
                <button data-lang="view.signin.continue"></button>
            </div>
        </form>
    </div>
</view-content>